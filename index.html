<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6200ea">
    <title>Workout Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            color: #212121;
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .app-header {
            background: linear-gradient(135deg, #6200ea 0%, #3700b3 100%);
            color: white;
            padding: 48px 20px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .app-header h1 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .app-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .back-button {
            position: absolute;
            left: 12px;
            top: 48px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            min-width: 48px;
            min-height: 48px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            cursor: pointer;
        }
        
        .card.completed {
            background: #c8e6c9;
            border-left: 4px solid #4caf50;
        }
        
        .card.active-week {
            background: #fff9c4;
            border-left: 4px solid #fdd835;
        }
        
        .card.deload {
            background: #ffe0b2;
            border-left: 4px solid #ff9800;
        }
        
        .card.compact {
            padding: 10px 16px;
            margin-bottom: 8px;
        }
        
        .card.compact h3 {
            font-size: 15px;
        }
        
        .card h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card p {
            font-size: 14px;
            color: #757575;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge.current {
            background: #fdd835;
            color: #000;
        }
        
        .badge.completed {
            background: #4caf50;
            color: white;
        }
        
        .badge.deload {
            background: #ff9800;
            color: white;
        }
        
        .exercise-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        
        .exercise-card.completed {
            background: #c8e6c9;
        }
        
        .exercise-card.failed {
            background: #ffcdd2;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .exercise-name {
            font-size: 16px;
            font-weight: 500;
            flex: 1;
        }
        
        .exercise-actions {
            display: flex;
            gap: 4px;
        }
        
        .icon-btn {
            background: rgba(0,0,0,0.04);
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            min-width: 40px;
            min-height: 40px;
        }
        
        .exercise-details {
            font-size: 14px;
            color: #757575;
            margin-bottom: 12px;
        }
        
        .next-session-info {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .next-session-info strong {
            color: #1976d2;
            display: block;
            margin-bottom: 4px;
            font-size: 15px;
        }
        
        .exercise-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-size: 12px;
            color: #757575;
            margin-bottom: 6px;
            display: block;
            font-weight: 500;
        }
        
        .input-with-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .input-with-buttons input {
            flex: 1;
            padding: 12px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
            text-align: center;
        }
        
        .increment-btn {
            background: #6200ea;
            color: white;
            border: none;
            width: 40px;
            height: 44px;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .increment-btn:active {
            background: #3700b3;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .completion-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            min-height: 48px;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-primary {
            background: #6200ea;
            color: white;
        }
        
        .btn-secondary {
            background: #757575;
            color: white;
        }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #6200ea;
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.24);
            z-index: 50;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            align-items: flex-end;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px 8px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-header h2 {
            font-size: 20px;
            font-weight: 500;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #757575;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
            color: #757575;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-group textarea {
            min-height: 80px;
            font-family: inherit;
        }
        
        .alert {
            background: #fff9c4;
            border-left: 4px solid #fdd835;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .progress-info {
            background: #e8eaf6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 13px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="app-header">
        <button class="back-button" id="backBtn" style="display: none;">‚Üê</button>
        <h1 id="headerTitle">Workout Tracker</h1>
        <p id="headerSubtitle">8-Week Training Cycle</p>
    </div>

    <div class="container">
        <div class="view active" id="weekView">
            <div id="weekList"></div>
        </div>

        <div class="view" id="dayView">
            <div id="dayList"></div>
        </div>

        <div class="view" id="exerciseView">
            <div id="exerciseList"></div>
        </div>
    </div>

    <button class="fab" id="addBtn" style="display: none;">+</button>

    <div class="modal" id="exerciseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Exercise</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="exerciseForm">
                <div class="form-group">
                    <label>Exercise Name</label>
                    <input type="text" id="exerciseName" required>
                </div>
                <div class="form-group">
                    <label>Exercise Type</label>
                    <select id="exerciseType">
                        <option value="weight">Weight-based (dumbbells)</option>
                        <option value="time">Time-based (cardio, planks)</option>
                        <option value="bodyweight">Bodyweight (reps only)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sets</label>
                    <input type="number" id="exerciseSets" min="1" value="3" required inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>Reps/Duration</label>
                    <input type="text" id="exerciseReps" value="8-12" required placeholder="e.g., 8-12 or 30s">
                </div>
                <div class="form-group">
                    <label>Tempo</label>
                    <input type="text" id="exerciseTempo" value="2-0-1-0">
                </div>
                <div class="form-group">
                    <label>Rest (seconds)</label>
                    <input type="number" id="exerciseRest" value="90" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="exerciseNotes" placeholder="Optional notes..."></textarea>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {}
        }

        document.addEventListener('DOMContentLoaded', requestWakeLock);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });

        function haptic(style = 'light') {
            if ('vibrate' in navigator) {
                navigator.vibrate(style === 'medium' ? 20 : 10);
            }
        }

        let workoutData = {
            currentCycle: 1,
            currentWeek: 1,
            weeks: []
        };

        let currentView = 'week';
        let selectedWeek = null;
        let selectedDay = null;
        let editingExerciseIndex = null;

        function initializeProgram() {
            const saved = localStorage.getItem('workoutData');
            if (saved) {
                workoutData = JSON.parse(saved);
            } else {
                for (let week = 1; week <= 8; week++) {
                    workoutData.weeks.push({
                        weekNumber: week,
                        completed: false,
                        isDeload: week === 4,
                        days: createDefaultDays(week)
                    });
                }
                saveData();
            }
            renderWeekView();
        }

        function createDefaultDays(weekNumber) {
            const isDeload = weekNumber === 4;
            const sets = isDeload ? 2 : 3;
            
            return [
                {
                    dayNumber: 1,
                    name: "Upper Push",
                    completed: false,
                    exercises: [
                        {name: "Incline DB Press", type: "weight", sets: sets, reps: "8-12", tempo: "3-1-1-1", rest: 90, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "DB Shoulder Press", type: "weight", sets: sets, reps: "8-12", tempo: "3-1-1-1", rest: 90, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Incline DB Fly", type: "weight", sets: isDeload ? 1 : 2, reps: "10-12", tempo: "2-1-1-0", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Lateral Raises", type: "weight", sets: isDeload ? 1 : 2, reps: "12-15", tempo: "2-0-1-1", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Overhead Triceps Extension", type: "weight", sets: isDeload ? 1 : 2, reps: "10-12", tempo: "2-0-2-0", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""}
                    ]
                },
                {
                    dayNumber: 2,
                    name: "Cardio & Core",
                    completed: false,
                    exercises: [
                        {name: "Cardio", type: "time", sets: 1, reps: "20 min", tempo: "-", rest: 0, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Plank", type: "time", sets: sets, reps: "20-30s", tempo: "-", rest: 45, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Dead Bug", type: "bodyweight", sets: sets, reps: "8-10/side", tempo: "-", rest: 45, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Glute Bridge", type: "bodyweight", sets: isDeload ? 1 : 2, reps: "12-15", tempo: "-", rest: 45, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""}
                    ]
                },
                {
                    dayNumber: 3,
                    name: "Upper Pull",
                    completed: false,
                    exercises: [
                        {name: "Inverted Rows", type: "bodyweight", sets: sets, reps: "6-10", tempo: "2-0-1-1", rest: 90, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "One-Arm DB Row", type: "weight", sets: sets, reps: "8-12", tempo: "2-1-1-1", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Rear Delt Raises", type: "weight", sets: isDeload ? 1 : 2, reps: "12-15", tempo: "2-0-1-1", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Incline DB Press", type: "weight", sets: isDeload ? 1 : 2, reps: "8-12", tempo: "3-1-1-1", rest: 90, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: "2nd session"},
                        {name: "Hammer Curls", type: "weight", sets: isDeload ? 1 : 2, reps: "10-12", tempo: "2-0-1-1", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Standard DB Curls", type: "weight", sets: isDeload ? 1 : 2, reps: "10-12", tempo: "2-0-1-1", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""}
                    ]
                },
                {
                    dayNumber: 4,
                    name: "Legs & Intervals",
                    completed: false,
                    exercises: [
                        {name: "Goblet Squat", type: "weight", sets: sets, reps: "8-12", tempo: "3-1-1-0", rest: 90, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Reverse Lunge", type: "weight", sets: isDeload ? 1 : 2, reps: "8-10/leg", tempo: "2-0-1-0", rest: 60, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Romanian Deadlift", type: "weight", sets: sets, reps: "8-12", tempo: "3-1-1-0", rest: 90, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Calf Raises", type: "weight", sets: isDeload ? 1 : 2, reps: "12-15", tempo: "1-1-1-1", rest: 45, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""},
                        {name: "Treadmill Intervals", type: "time", sets: 1, reps: "10 min", tempo: "-", rest: 0, weight: null, targetWeight: null, targetReps: null, weightChange: 0, repsChange: 0, completed: null, setResults: [], notes: ""}
                    ]
                }
            ];
        }

        function saveData() {
            localStorage.setItem('workoutData', JSON.stringify(workoutData));
        }

        function renderWeekView() {
            currentView = 'week';
            document.getElementById('weekView').classList.add('active');
            document.getElementById('dayView').classList.remove('active');
            document.getElementById('exerciseView').classList.remove('active');
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('addBtn').style.display = 'none';
            document.getElementById('headerTitle').textContent = 'Workout Tracker';
            document.getElementById('headerSubtitle').textContent = `Cycle ${workoutData.currentCycle}`;

            const list = document.getElementById('weekList');
            list.innerHTML = '';

            workoutData.weeks.forEach((week, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const isCurrent = i === workoutData.currentWeek - 1;
                const isCompact = week.completed || (!isCurrent && !week.completed);
                
                if (isCompact) card.classList.add('compact');
                if (week.completed) card.classList.add('completed');
                else if (isCurrent) card.classList.add('active-week');
                if (week.isDeload) card.classList.add('deload');

                const done = week.days.filter(d => d.completed).length;
                
                let badge = '';
                if (week.completed) badge = '<span class="badge completed">‚úì</span>';
                else if (isCurrent) badge = '<span class="badge current">Current</span>';
                if (week.isDeload) badge += ' <span class="badge deload">Deload</span>';

                card.innerHTML = `
                    <h3>Week ${week.weekNumber} <div>${badge}</div></h3>
                    <p>${done}/${week.days.length} days</p>
                    ${week.isDeload && !week.completed ? '<p style="color: #f57c00; margin-top: 8px;">‚ö†Ô∏è Reduce weight 30%</p>' : ''}
                `;
                
                card.onclick = () => {
                    haptic();
                    showDayView(i);
                };
                list.appendChild(card);
            });
        }

        function showDayView(weekIndex) {
            selectedWeek = weekIndex;
            currentView = 'day';
            
            document.getElementById('weekView').classList.remove('active');
            document.getElementById('dayView').classList.add('active');
            document.getElementById('exerciseView').classList.remove('active');
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('addBtn').style.display = 'none';
            
            const week = workoutData.weeks[weekIndex];
            document.getElementById('headerTitle').textContent = `Week ${week.weekNumber}`;
            document.getElementById('headerSubtitle').textContent = week.isDeload ? 'Deload Week' : '';

            const list = document.getElementById('dayList');
            list.innerHTML = '';

            week.days.forEach((day, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                if (day.completed) card.classList.add('completed');

                const done = day.exercises.filter(e => 
                    e.setResults && e.setResults.length === e.sets && e.setResults.every(s => s !== null)
                ).length;

                card.innerHTML = `
                    <h3>Day ${day.dayNumber} - ${day.name} ${day.completed ? '<span class="badge completed">‚úì</span>' : ''}</h3>
                    <p>${done}/${day.exercises.length} exercises</p>
                `;
                
                card.onclick = () => {
                    haptic();
                    showExerciseView(weekIndex, i);
                };
                list.appendChild(card);
            });
        }

        function showExerciseView(weekIndex, dayIndex) {
            selectedWeek = weekIndex;
            selectedDay = dayIndex;
            currentView = 'exercise';
            
            document.getElementById('weekView').classList.remove('active');
            document.getElementById('dayView').classList.remove('active');
            document.getElementById('exerciseView').classList.add('active');
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('addBtn').style.display = 'block';
            
            const week = workoutData.weeks[weekIndex];
            const day = week.days[dayIndex];
            
            document.getElementById('headerTitle').textContent = `Day ${day.dayNumber}`;
            document.getElementById('headerSubtitle').textContent = day.name;

            renderExerciseList();
        }

        function renderExerciseList() {
            const week = workoutData.weeks[selectedWeek];
            const day = week.days[selectedDay];
            const list = document.getElementById('exerciseList');
            list.innerHTML = '';

            if (week.isDeload) {
                const alert = document.createElement('div');
                alert.className = 'alert';
                alert.innerHTML = '‚ö†Ô∏è <strong>Deload Week:</strong> Consider reducing weight by 30%';
                list.appendChild(alert);
            }

            day.exercises.forEach((ex, i) => {
                const card = document.createElement('div');
                card.className = 'exercise-card';
                
                if (!ex.setResults) ex.setResults = [];
                
                const completedSets = ex.setResults.filter(s => s === true).length;
                const failedSets = ex.setResults.filter(s => s === false).length;
                const allSetsComplete = ex.setResults.length === ex.sets && ex.setResults.every(s => s !== null);
                
                if (allSetsComplete && failedSets === 0) {
                    card.classList.add('completed');
                } else if (failedSets > 0) {
                    card.classList.add('failed');
                }

                if (!ex.type) ex.type = 'weight';

                if (selectedWeek > 0 && ex.weight === null && ex.type === 'weight') {
                    const prev = workoutData.weeks[selectedWeek - 1].days[selectedDay].exercises[i];
                    if (prev && prev.name === ex.name) {
                        ex.weight = (prev.targetWeight || 0) + (prev.weightChange || 0);
                        ex.targetWeight = ex.weight;
                        ex.targetReps = prev.targetReps;
                    }
                }

                const isWeightBased = ex.type === 'weight';
                const isTimeBased = ex.type === 'time';
                const w = ex.weight !== null ? `${ex.weight} lbs` : 'Not set';
                const r = ex.targetReps || ex.reps;

                let nextSessionInfo = '';
                if (selectedWeek < 7 && allSetsComplete) {
                    const nextWeight = isWeightBased ? (ex.weight + ex.weightChange) : null;
                    const nextReps = ex.repsChange !== 0 ? `${ex.repsChange >= 0 ? '+' : ''}${ex.repsChange} reps` : 'Same';
                    
                    nextSessionInfo = `
                        <div class="next-session-info">
                            <strong>üìÖ Next Week (Week ${selectedWeek + 2}):</strong>
                            ${isWeightBased ? `Weight: ${nextWeight} lbs | ` : ''}Reps: ${nextReps}
                        </div>
                    `;
                }

                let inputsHtml = '';
                if (!allSetsComplete) {
                    if (isWeightBased) {
                        inputsHtml = `
                            <div class="exercise-inputs">
                                <div class="input-group">
                                    <label>Weight (lbs)</label>
                                    <div class="input-with-buttons">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'weight', -2.5)">‚àí</button>
                                        <input type="number" step="0.5" value="${ex.weight || ''}" 
                                            onchange="updateExerciseWeight(${i}, this.value)" 
                                            placeholder="0" inputmode="decimal">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'weight', 2.5)">+</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Reps Done</label>
                                    <div class="input-with-buttons">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'reps', -1)">‚àí</button>
                                        <input type="text" value="${ex.targetReps || ''}" 
                                            onchange="updateExerciseReps(${i}, this.value)" 
                                            placeholder="10" inputmode="numeric">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'reps', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="exercise-inputs">
                                <div class="input-group">
                                    <label>Next Week Weight Œî</label>
                                    <div class="input-with-buttons">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'weightChange', -2.5)">‚àí</button>
                                        <input type="number" step="0.5" value="${ex.weightChange || 0}" 
                                            onchange="updateWeightChange(${i}, this.value)" 
                                            inputmode="decimal">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'weightChange', 2.5)">+</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Next Week Reps Œî</label>
                                    <div class="input-with-buttons">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'repsChange', -1)">‚àí</button>
                                        <input type="number" value="${ex.repsChange || 0}" 
                                            onchange="updateRepsChange(${i}, this.value)" 
                                            inputmode="numeric">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'repsChange', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (isTimeBased) {
                        inputsHtml = `
                            <div class="exercise-inputs">
                                <div class="input-group">
                                    <label>Duration Completed</label>
                                    <input type="text" value="${ex.targetReps || ''}" 
                                        onchange="updateExerciseReps(${i}, this.value)" 
                                        placeholder="30s or 5 min">
                                </div>
                                <div class="input-group">
                                    <label>Next Week Duration Œî</label>
                                    <input type="text" value="${ex.repsChange || 0}" 
                                        onchange="updateRepsChange(${i}, this.value)" 
                                        placeholder="+5s or +1 min">
                                </div>
                            </div>
                        `;
                    } else {
                        inputsHtml = `
                            <div class="exercise-inputs">
                                <div class="input-group">
                                    <label>Reps Done</label>
                                    <div class="input-with-buttons">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'reps', -1)">‚àí</button>
                                        <input type="text" value="${ex.targetReps || ''}" 
                                            onchange="updateExerciseReps(${i}, this.value)" 
                                            placeholder="10" inputmode="numeric">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'reps', 1)">+</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Next Week Reps Œî</label>
                                    <div class="input-with-buttons">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'repsChange', -1)">‚àí</button>
                                        <input type="number" value="${ex.repsChange || 0}" 
                                            onchange="updateRepsChange(${i}, this.value)" 
                                            inputmode="numeric">
                                        <button class="increment-btn" onclick="changeValue(${i}, 'repsChange', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                let setsHtml = '';
                if (!allSetsComplete) {
                    setsHtml = '<div style="margin-bottom: 12px;">';
                    for (let setNum = 0; setNum < ex.sets; setNum++) {
                        const setStatus = ex.setResults[setNum];
                        let btnClass = 'btn btn-secondary';
                        let btnText = `Set ${setNum + 1}`;
                        
                        if (setStatus === true) {
                            btnClass = 'btn btn-success';
                            btnText = `Set ${setNum + 1} ‚úì`;
                        } else if (setStatus === false) {
                            btnClass = 'btn btn-danger';
                            btnText = `Set ${setNum + 1} ‚úó`;
                        }
                        
                        setsHtml += `<button class="${btnClass}" style="margin: 4px 4px; width: calc(50% - 8px);" onclick="toggleSet(${i}, ${setNum})">${btnText}</button>`;
                    }
                    setsHtml += '</div>';
                } else {
                    setsHtml = '<div class="progress-info" style="margin-bottom: 12px;"><strong>‚úì All Sets Complete</strong><br>';
                    for (let setNum = 0; setNum < ex.sets; setNum++) {
                        const icon = ex.setResults[setNum] ? '‚úì' : '‚úó';
                        setsHtml += `<span style="margin-right: 8px;">Set ${setNum + 1}: ${icon}</span>`;
                    }
                    setsHtml += `<button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" onclick="resetExercise(${i})">Reset All Sets</button></div>`;
                }

                card.innerHTML = `
                    <div class="exercise-header">
                        <div class="exercise-name">${ex.name}</div>
                        <div class="exercise-actions">
                            <button class="icon-btn" onclick="editExercise(${i})">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deleteExercise(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="exercise-details">
                        ${ex.sets} sets √ó ${r} | ${ex.tempo} | ${ex.rest}s rest
                        ${ex.notes ? `<br><em>${ex.notes}</em>` : ''}
                        <br><strong>Completed: ${completedSets}/${ex.sets}</strong>
                    </div>
                    ${nextSessionInfo}
                    ${!allSetsComplete ? inputsHtml : ''}
                    ${setsHtml}
                `;
                
                list.appendChild(card);
            });

            const allExercisesComplete = day.exercises.every(ex => 
                ex.setResults && ex.setResults.length === ex.sets && ex.setResults.every(s => s !== null)
            );
            
            if (allExercisesComplete && !day.completed) {
                day.completed = true;
                
                const allDays = week.days.every(d => d.completed);
                if (allDays) {
                    week.completed = true;
                    if (selectedWeek < 7) {
                        workoutData.currentWeek = selectedWeek + 2;
                    } else {
                        if (confirm('Cycle complete! Start new cycle?')) {
                            startNewCycle();
                        }
                    }
                }
                
                saveData();
                haptic('medium');
                alert('üéâ Day complete!');
            }
        }

        function toggleSet(exerciseIndex, setIndex) {
            haptic('medium');
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            const ex = day.exercises[exerciseIndex];
            
            if (!ex.setResults) ex.setResults = [];
            
            if (ex.setResults[setIndex] === undefined || ex.setResults[setIndex] === null) {
                ex.setResults[setIndex] = true;
            } else if (ex.setResults[setIndex] === true) {
                ex.setResults[setIndex] = false;
            } else {
                ex.setResults[setIndex] = null;
            }
            
            saveData();
            renderExerciseList();
        }

        function changeValue(index, field, delta) {
            haptic();
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            const ex = day.exercises[index];
            
            if (field === 'weight') {
                ex.weight = Math.max(0, (ex.weight || 0) + delta);
                ex.targetWeight = ex.weight;
            } else if (field === 'reps') {
                const current = parseInt(ex.targetReps) || 0;
                ex.targetReps = Math.max(0, current + delta).toString();
            } else if (field === 'weightChange') {
                ex.weightChange = (ex.weightChange || 0) + delta;
            } else if (field === 'repsChange') {
                ex.repsChange = (ex.repsChange || 0) + delta;
            }
            
            saveData();
            renderExerciseList();
        }

        function updateExerciseWeight(i, v) {
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            day.exercises[i].weight = parseFloat(v) || 0;
            day.exercises[i].targetWeight = parseFloat(v) || 0;
            saveData();
        }

        function updateExerciseReps(i, v) {
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            day.exercises[i].targetReps = v;
            saveData();
        }

        function updateWeightChange(i, v) {
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            day.exercises[i].weightChange = parseFloat(v) || 0;
            saveData();
        }

        function updateRepsChange(i, v) {
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            day.exercises[i].repsChange = parseInt(v) || 0;
            saveData();
        }

        function resetExercise(i) {
            if (confirm('Reset all sets for this exercise?')) {
                haptic();
                const day = workoutData.weeks[selectedWeek].days[selectedDay];
                day.exercises[i].setResults = [];
                day.exercises[i].completed = null;
                saveData();
                renderExerciseList();
            }
        }

        function startNewCycle() {
            const lastWeek = workoutData.weeks[7];
            
            workoutData.currentCycle++;
            workoutData.currentWeek = 1;
            workoutData.weeks = [];
            
            for (let week = 1; week <= 8; week++) {
                const isDeload = week === 4;
                const newWeek = {
                    weekNumber: week,
                    completed: false,
                    isDeload: isDeload,
                    days: []
                };
                
                lastWeek.days.forEach(lastDay => {
                    const newDay = {
                        dayNumber: lastDay.dayNumber,
                        name: lastDay.name,
                        completed: false,
                        exercises: []
                    };
                    
                    lastDay.exercises.forEach(lastEx => {
                        const finalWeight = (lastEx.targetWeight || lastEx.weight || 0) + (lastEx.weightChange || 0);
                        
                        newDay.exercises.push({
                            name: lastEx.name,
                            type: lastEx.type || 'weight',
                            sets: isDeload ? Math.round(lastEx.sets * 0.67) : lastEx.sets,
                            reps: lastEx.reps,
                            tempo: lastEx.tempo,
                            rest: lastEx.rest,
                            weight: finalWeight,
                            targetWeight: finalWeight,
                            targetReps: null,
                            weightChange: 0,
                            repsChange: 0,
                            completed: null,
                            setResults: [],
                            notes: lastEx.notes
                        });
                    });
                    
                    newWeek.days.push(newDay);
                });
                
                workoutData.weeks.push(newWeek);
            }
            
            saveData();
            renderWeekView();
        }

        function openAddExerciseModal() {
            haptic();
            editingExerciseIndex = null;
            document.getElementById('modalTitle').textContent = 'Add Exercise';
            document.getElementById('exerciseForm').reset();
            document.getElementById('exerciseModal').classList.add('active');
        }

        function editExercise(i) {
            haptic();
            editingExerciseIndex = i;
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            const ex = day.exercises[i];
            
            document.getElementById('modalTitle').textContent = 'Edit Exercise';
            document.getElementById('exerciseName').value = ex.name;
            document.getElementById('exerciseType').value = ex.type || 'weight';
            document.getElementById('document.getElementById('exerciseModal').classList.add('active');
    }

    function deleteExercise(i) {
        if (confirm('Delete this exercise?')) {
            haptic('medium');
            const day = workoutData.weeks[selectedWeek].days[selectedDay];
            day.exercises.splice(i, 1);
            saveData();
            renderExerciseList();
        }
    }

    function closeModal() {
        haptic();
        document.getElementById('exerciseModal').classList.remove('active');
    }

    document.getElementById('exerciseForm').onsubmit = function(e) {
        e.preventDefault();
        haptic('medium');
        
        const exData = {
            name: document.getElementById('exerciseName').value,
            type: document.getElementById('exerciseType').value,
            sets: parseInt(document.getElementById('exerciseSets').value),
            reps: document.getElementById('exerciseReps').value,
            tempo: document.getElementById('exerciseTempo').value,
            rest: parseInt(document.getElementById('exerciseRest').value),
            weight: null,
            targetWeight: null,
            targetReps: null,
            weightChange: 0,
            repsChange: 0,
            completed: null,
            setResults: [],
            notes: document.getElementById('exerciseNotes').value
        };
        
        const day = workoutData.weeks[selectedWeek].days[selectedDay];
        
        if (editingExerciseIndex !== null) {
            const existing = day.exercises[editingExerciseIndex];
            exData.weight = existing.weight;
            exData.targetWeight = existing.targetWeight;
            exData.targetReps = existing.targetReps;
            exData.weightChange = existing.weightChange;
            exData.repsChange = existing.repsChange;
            exData.completed = existing.completed;
            exData.setResults = existing.setResults || [];
            
            day.exercises[editingExerciseIndex] = exData;
        } else {
            day.exercises.push(exData);
        }
        
        saveData();
        closeModal();
        renderExerciseList();
    };

    document.getElementById('backBtn').onclick = function() {
        haptic();
        if (currentView === 'exercise') {
            showDayView(selectedWeek);
        } else if (currentView === 'day') {
            renderWeekView();
        }
    };

    document.getElementById('addBtn').onclick = function() {
        openAddExerciseModal();
    };

    initializeProgram();
</script>
